name: Cross-Repo Integration Tests

on:
  pull_request:
    paths:
      - 'src/db-backend/**'
      - '.github/rr-backend-pin.txt'
      - 'scripts/run-cross-repo-tests.sh'
      - '.github/workflows/cross-repo-tests.yml'
  push:
    branches: [main]
    paths:
      - 'src/db-backend/**'
      - '.github/rr-backend-pin.txt'
      - 'scripts/run-cross-repo-tests.sh'
      - '.github/workflows/cross-repo-tests.yml'
  workflow_dispatch:
    inputs:
      rr_backend_ref:
        description: 'rr-backend git ref to test against (default: from pin file)'
        required: false
        default: ''

permissions:
  contents: read
  id-token: write

jobs:
  cross-repo-tests:
    runs-on: [self-hosted, nixos]

    steps:
      - name: Checkout codetracer
        uses: actions/checkout@v5
        with:
          submodules: recursive
          token: ${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}

      - name: Install Nix
        uses: ./.github/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          gh-token: ${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}

      - name: Resolve rr-backend ref
        id: resolve-ref
        run: |
          if [[ -n "${{ github.event.inputs.rr_backend_ref }}" ]]; then
            REF="${{ github.event.inputs.rr_backend_ref }}"
          elif [[ -f .github/rr-backend-pin.txt ]]; then
            REF="$(head -1 .github/rr-backend-pin.txt | tr -d '[:space:]')"
          fi
          REF="${REF:-main}"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Resolved rr-backend ref: $REF"

      - name: Clone rr-backend
        run: |
          REF="${{ steps.resolve-ref.outputs.ref }}"
          echo "Cloning codetracer-rr-backend at ref: $REF"

          # Rewrite all GitHub URL styles to authenticated HTTPS.
          # Submodules may use SSH or HTTPS URLs in .gitmodules, so we cover all:
          #   git@github.com:org/repo.git    -> https://token@github.com/org/repo.git
          #   ssh://git@github.com/org/repo  -> https://token@github.com/org/repo
          #   https://github.com/org/repo    -> https://token@github.com/org/repo
          git config --global url."https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/".insteadOf "https://github.com/"

          git clone \
            "https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/metacraft-labs/codetracer-rr-backend.git" \
            target/rr-backend-clone
          cd target/rr-backend-clone
          git checkout "$REF"

          # Initialize submodules and explicitly rewrite their URLs to include the
          # access token. The url.insteadOf config may not always apply to submodule
          # URLs already written to .git/config.
          git submodule init
          for url in $(git config --get-regexp '^submodule\..*\.url$' | grep -E 'git@github\.com:|https://github\.com/' | cut -d' ' -f1); do
            old_url=$(git config --get "$url")
            new_url=$(echo "$old_url" \
              | sed "s|git@github.com:|https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/|" \
              | sed "s|https://github.com/|https://x-access-token:${{ secrets.GH_READ_METACRAFT_PRIVATE_REPOS }}@github.com/|")
            echo "Rewriting submodule URL: $url"
            git config "$url" "$new_url"
          done
          git submodule update --recursive

      - name: Build ct-rr-support
        run: |
          nix develop ./target/rr-backend-clone --command \
            bash -c "cd target/rr-backend-clone && cargo build"

      - name: Resolve rr-backend environment paths
        id: rr-libs
        run: |
          # Use markers to extract paths cleanly (nix develop may print banners)
          RAW="$(nix develop ./target/rr-backend-clone --command bash -c \
            'echo "___LD_PATH_START___"; echo "$LD_LIBRARY_PATH"; echo "___LD_PATH_END___";
             echo "___PATH_START___"; echo "$PATH"; echo "___PATH_END___"')"
          RR_LD="$(echo "$RAW" | sed -n '/___LD_PATH_START___/{n;p;}')"
          RR_PATH="$(echo "$RAW" | sed -n '/___PATH_START___/{n;p;}')"
          echo "ld_library_path=$RR_LD" >> "$GITHUB_OUTPUT"
          echo "extra_path=$RR_PATH" >> "$GITHUB_OUTPUT"
          echo "Resolved rr-backend LD_LIBRARY_PATH: $RR_LD"
          echo "Resolved rr-backend PATH (first 200 chars): ${RR_PATH:0:200}..."

      - name: Run cross-repo integration tests
        run: |
          CT_RR_SUPPORT="$(pwd)/target/rr-backend-clone/target/debug/ct-rr-support"
          echo "Using ct-rr-support: $CT_RR_SUPPORT"
          RR_EXTRA_PATH="${{ steps.rr-libs.outputs.extra_path }}"
          RR_LD="${{ steps.rr-libs.outputs.ld_library_path }}"
          nix develop .#devShells.x86_64-linux.default --command \
            bash -c "
              export PATH=\"${RR_EXTRA_PATH}:\$PATH\"
              export CT_RR_SUPPORT_PATH=\"${CT_RR_SUPPORT}\"
              export CT_RR_SUPPORT_LD_LIBRARY_PATH=\"${RR_LD}\"
              export CODETRACER_RR_SOFT_MODE=1
              ./scripts/run-cross-repo-tests.sh --soft all
            "

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cross-test-logs
          path: target/cross-test-logs/
          retention-days: 14
          if-no-files-found: ignore
