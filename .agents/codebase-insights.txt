# Codebase insights
- Ruby loops were originally detected only for 'while' and 'until'.
- 'each' loops can be recognized by handling 'call' nodes with a block whose method name is 'each'.
- Added a regression test ensuring `ExprLoader` detects Ruby `each` loops correctly.
- The `tui` crate contains a sample trace under `src/tui/trace/` used for basic testing.
- The Debug Adapter Protocol client communicates over a Unix domain socket using the same framing protocol, implemented in `src/tui/src/dap_client.rs`.
- Pointer address formatting relies on JS `BigInt` via `importjs` for renderer builds, while native builds use standard parsing (`formatPointerAddress` in `src/common/common_types/utils/text_representation.nim`), avoiding Nim-to-JS uint64 quirks.
- Added initial SetBreakpoints handling in db-backend DAP server.
- When using the DAP stdio transport, all diagnostic output must go to stderr
  to avoid corrupting the message stream.
- `src/db-backend/src/main.rs` sends startup diagnostics to stderr (not stdout), and `src/db-backend/tests/dap_backend_stdio.rs` now guards stdio framing with both an initialize-handshake test and a disconnect-response-plus-process-exit test against real `dap-server --stdio`.
- `DapParser` now buffers data via `add_bytes` and exposes parsed payloads with
  `get_message()`, so callers need to drain messages until `None` after feeding
  new bytes.
- `DbReplay::toggle_breakpoint` now mutates its internal breakpoint cache so
  handler state stays consistent after toggles.
- BackendManager now auto-selects the most recently started replay so new DAP
  traffic targets the fresh db-backend without needing an explicit
  `ct/select-replay`.

- Ruby LSP operates diagnostics in pull mode (`textDocument/diagnostic`), and
  only reports semantic issues when a linter such as RuboCop is configured
  (e.g., via `.rubocop.yml` or `linters: ["rubocop_internal"]` in the
  initialize request). Without a linter the server only returns syntax
  warnings, so `missing_helper`-style errors won't surface.


- The db-backend DAP server now responds to the `configurationDone` request.

- Electron lifecycle: the backend-manager process is spawned in
  `src/frontend/index.nim` during `ready()`. Previously, it was only stopped
  via an explicit UI action. We now centralize cleanup with `stopBackendManager()`
  and hook it to `app.on('before-quit')`, `app.on('window-all-closed')`, and
  Node process signals (`SIGINT`, `SIGTERM`, `SIGHUP`) to ensure the process
  is always terminated when the app exits.
- `ct record` now prefers `CODETRACER_PYTHON_INTERPRETER`, `PYTHON_EXECUTABLE`, `PYTHONEXECUTABLE`, or PATH resolution to locate the Python runtime before delegating to the db backend, and `db-backend-record` expects the resolved interpreter via `--python-interpreter` when launching the recorder.
- `ct record` resolves Python via env vars (`CODETRACER_PYTHON_INTERPRETER`, `PYTHON_EXECUTABLE`, `PYTHONEXECUTABLE`, `PYTHON`) before checking PATH. When falling back to PATH we now call `findExe(..., followSymlinks=false)` so virtualenv launchers keep their original location and `pyvenv.cfg` remains discoverable.
- Interpreter overrides (e.g. `CODETRACER_PYTHON_INTERPRETER`) are now treated as authoritative; if the configured path cannot be resolved we error instead of silently falling back to PATH.
- `ct record` verifies that `codetracer_python_recorder` is importable before launching the db backend and prints actionable guidance if the module is missing or broken.
- Sudoku test-program datasets include intentionally invalid boards (e.g., examples #3 and #6) with duplicate digits inside a sub-grid; solvers should detect and report these gracefully.
- `ct remote` shells out to `ct-remote`, first checking alongside the `ct` binary and then falling back to the user's PATH if needed; errors are surfaced with actionable messaging when the binary is missing.
- Nix packaging now fetches the prebuilt DesktopClient.App binary, patches its glibc interpreter/RPATH via `patchelf`, and installs it alongside the main `ct`; the devshell, AppImage build (with safe cleanup for `squashfs-root`), non-nix build, and Python wheel build all reuse the same binary so `ct-remote` ships with every distribution path.
- `launchElectron()` uses `execv` on POSIX to replace the ct process with Electron, allowing Playwright to connect via CDP. It sets up `LINKS_PATH_DIR` and `NIX_CODETRACER_EXE_DIR` before execv so the Electron renderer can locate `backend-manager`. The `--inspect` and `--remote-debugging-port` flags are forwarded to Electron.
- The `ct host` CLI expects options in the `--flag=value` form; passing space-delimited values (e.g. `--frontend-socket 1234`) leaves the value empty and the command falls back to default ports, so parallel hosts collide.
- `ct host` exposes a single socket.io listener; keep `--frontend-socket` equal to `--backend-socket-port` when launching multiple hosts so the browser connects to the active socket server.
- In server mode `ct host` registers IPC handlers on the first socket.io client only; after a browser reload/new tab the backend never reattaches listeners, so the fresh socket cannot reach the handler table.
- Server builds now accept `--welcome-screen` so host smoke tests can boot the welcome flow; bootstrap replay requires acknowledging `CODETRACER::started` before the rest of the cached payloads emit.
- Server-mode `mainWindow.webContents.send` now caches bootstrap IPC payloads (started/init/welcome/no-trace/trace load) in `data.bootstrapMessages`; `ipc.replayBootstrap` replays the cache to the latest socket using `bootstrap_cache.nim` ordering.
- 2025-11-07: The temporary `ui-tests-playground` and `ui-tests-startup-example` folders were removed; their startup/bootstrap guidance now lives in `ui-tests-v3/docs/` (notably `launching-multi-instance.md` and `settings-infrastructure.md`). Refer to those docs instead of the deleted projects.
- `ui-tests` now mirrors that host bootstrap: `Program.cs` wires `AppSettings` into `Execution/TestExecutionPipeline`, fanning out each scenario across both Electron and Web executors while `Runner.MaxParallelInstances` (and the `--max-parallel` CLI flag) throttle concurrency.
- `Infrastructure/CodetracerLauncher.RecordProgramAsync` accepts Noir directories as well as Ruby/Python files, matching `ct record` semantics; when `Web.DefaultTraceDirectory` is unset it falls back to `~/.local/share/codetracer`.
- `trace_index.ensureDB` enables SQLite WAL mode and a 60s busy timeout so parallel `ct record` processes wait on locks instead of failing with “database is locked”.
- Scratchpad entries are sourced from multiple panes via `InternalAddToScratchpad`: calltrace arguments, flow before/after values, trace table rows, editor trace results, and value tooltips/context menus all emit that event, so UI tests should cover each surface explicitly.
- Most panes use the global `#context-menu-container` element for menu actions, but the filesystem tree relies on jstree's `#vakata-contextmenu`, so page objects/tests need to open the correct container.
- launch ui-tests commands through `direnv exec .` (or an equivalent `nix shell`) so the flake-provided dotnet toolchain and Playwright node runtime land on PATH; invoking `dotnet` directly from `bash -lc` skips direnv hooks.
- The default `appsettings.json` only wires Noir scenarios; to exercise ProgramAgnostic tests, supply a custom config overriding `Scenarios` and pass it via `--config=/abs/path`.
- Electron and Web builds use different keyboard shortcuts for command palette and Monaco actions; until we emit platform-aware chords, keep those program-agnostic tests commented out in `Execution/TestRegistry`.
- Call trace navigation currently requires expanding the parent entry; even with expanded children the UI may ignore single clicks, so tests now fall back to double-clicks/forced clicks and still rely on Monaco updates—further instrumentation of the renderer may be needed.
- Use `UiTests.Utils.DebugLogger` (default `ui-tests/bin/Debug/net8.0/ui-tests-debug.log`, override with `UITESTS_DEBUG_LOG`) to trace retry loops and click attempts—`RetryHelpers` and key page objects now emit detailed timestamps.
- Scenario configs now support `\"verboseLogging\": true` to opt-in to DebugLogger + console chatter; otherwise the harness runs quietly and only prints the final color-coded summary unless a test fails. Runner-level `Runner.VerboseConsole` (toggle via `--verbose-console`) also enables verbose lifecycle logging globally.
- `ct host` now accepts `--idle-timeout` (env: `CODETRACER_HOST_IDLE_TIMEOUT`, default 10m; units ms/s/m/h; `0`/`never` disable) and passes `--idle-timeout-ms` to server mode, which tracks last connection/activity and exits cleanly on idle.
- Server mode now refreshes idle activity on every inbound socket.io event via `onAny`; the `__activity__` ping remains as a cheap manual/testing hook but is no longer required to keep the host alive during normal IPC traffic. Disconnects reset the “no-connection” timer so idle shutdown counts from the last detach.
- Server mode emits `CODETRACER::connection-disconnected` to superseded sockets and before idle-timeout exits; the browser tracks this plus socket disconnects to show a persistent warning (with reconnect action) and a status-bar “Disconnected” badge.
- Webpack expects the `vscode` alias to point at the `@codingame/monaco-vscode-extension-api` package root so that `monaco-languageclient` can load `vscode/localExtensionHost`.
- A Nim-side diagnostics/sync router now tracks Monaco editors per normalized path (including trace `files/` snapshots), sends `textDocument/didOpen|didChange|didClose` notifications for each live buffer, and proactively requests `textDocument/diagnostic` so Ruby warnings land in the correct tab even without MonacoServices.
- `initLspController` now delegates to `registerKindController`, ensuring each language kind registers its observer with an independent closure so the correct LSP client starts when its URL is received.
- LSP startup only begins once a Monaco editor of that kind is registered; document observers fire when the first tab opens, allowing the client to start with real context instead of empty workspaces.
- Only the Ruby LSP supports pull diagnostics (`textDocument/diagnostic`); other languages rely on `publishDiagnostics`, so guard `requestDiagnostics` by kind to avoid crashing rust-analyzer.
- ACP IPC streams `agent_message_chunk` updates with a stable message id (append=true) and then sends the aggregated content when the prompt stops; `agent_activity` appends content for existing ids or creates a new message when a fresh id arrives.
- In `acp_ipc`, prompt text may arrive as either a plain string or `{text: ...}`; normalize the input to a cstring before sending the prompt to avoid `[object Object]` propagation.
- The ACP prompt request must pass the message value directly (`text: #`) rather than embedding the parameter name as a literal (`text: '#'`), otherwise the agent receives a generated identifier like `text_2684354635` instead of the user’s input.
- `agent_activity` now appends when a message id already exists, without relying on an explicit `append` flag; new ids create new message entries automatically.
- ACP streaming now sends only chunks plus a final stop-reason notification (no aggregated content), and the UI renders the user’s prompt immediately as a user message before the agent replies.
- Agent activity messages only render after `updateAgentMessageContent` stores the content and triggers a redraw; missing that step leaves the UI unchanged even though responses arrive.
- ACP client now implements `readTextFile` via Node fs (UTF-8) and `createTerminal` (returns `acp-term-N` or provided id). The terminal creation is still a stub (no UI terminal), but agents get a stable id and real file contents on request.
- `createTerminal` now also notifies the renderer (`CODETRACER::acp-create-terminal`) with the requested id/params so the UI can hook up a terminal when implemented.
- Agent activity persists terminal entries (order + id) and renders a terminal placeholder per `createTerminal` event, mirroring how messages are stored and rendered.
- Agent activity now spins up a real ShellComponent for each ACP terminal, rendering a container and lazily calling `createShell` after mount so xterm attaches to the correct DOM node.
- ACP IPC keeps a single long-lived agent process/connection/session; `acp-init-session` primes it, and prompts reuse that session instead of spawning a new process each time.
- ACP client now implements `writeTextFile` via Node fs (UTF-8); missing paths return errors and successful writes return `{ok: true}`, enabling agent-applied edits to be diffed locally.
- Tracepoint interpreter stack now operates on `ValueRecordWithType`; literal pushes carry `TypeRecord`s, operator functions propagate those types, and logging converts via `value::to_ct_value` without `Db`.

- Windows DIY bootstrap defaults to a shared per-user cache root (`%LOCALAPPDATA%/codetracer/windows-diy`, or POSIX equivalent from `non-nix-build/windows/env.sh`), while still honoring `WINDOWS_DIY_INSTALL_ROOT` and `-InstallRoot` overrides; versioned/cache subdirectory layout remains deterministic under that root.
- `non-nix-build/windows/validate-toolchain-versions.ps1` is the single source for toolchain env validation (required keys exactly once + version-like values), and `windows-bootstrap-smoke` calls it directly.
- DAP transport currently uses Unix domain sockets on both ends of the Rust path: `db-backend` connects with `UnixStream` in `src/db-backend/crates/db-backend-core/src/dap_server.rs`, while the listener side is created in `src/tui/src/dap_client.rs` and `src/db-backend/tests/test_harness/mod.rs`.
- `src/db-backend/tests/test_harness/mod.rs` and `src/db-backend/tests/dap_backend_server.rs` now gate Unix-domain-socket test code with `cfg(unix)`; on non-Unix, flow harness availability checks print explicit skip/unsupported messaging instead of failing to compile.
- DAP endpoint naming is now centralized in `transport_endpoint` helpers; `src/db-backend/src/dap_server.rs::socket_path_for` intentionally keeps the Unix socket suffix `.sock` to preserve existing behavior.
- `src/db-backend/src/dap_server.rs` now uses real Windows named-pipe client connect for `DapEndpoint::WindowsNamedPipe` via `WaitNamedPipeW` plus `std::fs::OpenOptions` handle open, avoiding direct `CreateFileW` symbol coupling while keeping explicit endpoint/error diagnostics and no stdio fallback.
- `src/tui/src/dap_client.rs` now runs a real Windows listener flow: it creates `\\.\pipe\ct_dap_socket_<pid>` with `CreateNamedPipeW`, spawns `db-backend` with that endpoint, then accepts via `ConnectNamedPipe` (retry/timeout) before reusing the same DAP framing read/write path as Unix.
- `src/tui/src/dap_client.rs` Windows transport tests can perform a deterministic in-process handshake by opening `\\.\pipe\...` with `std::fs::OpenOptions` as the client while `accept_windows_named_pipe_client` waits on the listener.
- `src/tui/src/dap_client.rs` now includes an executable Windows-only integration test that runs `DapClient::start` against a spawned mock-backend process and verifies the real named-pipe DAP handshake path for `initialize`, `launch`, and initialized-event-triggered `configurationDone`.
- `DapClient::start` on Windows binds `\\.\pipe\ct_dap_socket_<pid>` with `FILE_FLAG_FIRST_PIPE_INSTANCE`, so multiple concurrent `start` attempts from the same process can collide; tests that exercise `start` should serialize those cases.
- Windows named-pipe DAP sessions can be restarted in the same process after clean teardown: a second `DapClient::start` using the same PID-based endpoint naming pattern (`\\.\pipe\ct_dap_socket_<pid>`) succeeds once the prior session has fully exited and handles are dropped.
- `non-nix-build/windows/bootstrap-windows-diy.ps1` verifies pinned `DesktopClient.App-win-x64-<revision>.tar.gz` downloads with `CT_REMOTE_WIN_X64_SHA256`; pinned download mode is still x64-only, but Windows arm64 now routes `CT_REMOTE_WINDOWS_SOURCE_MODE=auto` to local source and does not fall back to x64 download.
- Cap'n Proto Windows bootstrap now supports `CAPNP_WINDOWS_SOURCE_MODE=auto|source|prebuilt`; prebuilt mode stays pinned to `https://capnproto.org/capnproto-c++-win32-<version>.zip` with repo-managed `CAPNP_WIN_X64_SHA256`, while source mode caches deterministic installs under `.tools/windows-diy/capnp/<version>/cache/source/<cache-key>/` and reuses them via `capnp.source.meta` + `capnp.install.meta`.
- Windows DIY Nim bootstrap supports `NIM_WINDOWS_SOURCE_MODE=auto|source|prebuilt`; source mode cache semantics remain deterministic under `$WINDOWS_DIY_INSTALL_ROOT/nim/<version>/cache/source/<cache-key>/` with `nim.source.meta` reuse checks, `prebuilt` is explicitly x64-only, and `auto` on arm64 fails after a source attempt instead of falling back to x64 prebuilt.
- Nim source bootstrap compiler selection is now explicit: `NIM_WINDOWS_SOURCE_CC=auto|gcc|vcc` (default `auto`) prefers gcc when available, can provision/reuse pinned Tup MSYS2 gcc when enabled (`NIM_WINDOWS_SOURCE_BOOTSTRAP_GCC_FROM_TUP_MSYS2=1`), and only falls back to MSVC when gcc is unavailable or `vcc` is requested.
- `non-nix-build/windows/env.sh` should not leave strict error mode in the caller shell: when sourced, it now restores prior shell options and still returns non-zero on setup failure; it also auto-installs missing Node deps by default (`WINDOWS_DIY_SETUP_NODE_DEPS=1`) so `stylus.cmd`/`webpack.cmd` are present for `just build-once` and Tup CSS rules.
- On Windows arm64 machines, current Nim source bootstrap in `non-nix-build/windows/bootstrap-windows-diy.ps1` is workable by pairing source mode with VS Build Tools discovery and an x64 bootstrap/toolchain path (because current `csources_v3` checkouts do not contain `bin/nim.exe`); cache reuse is explicit via `Nim <ver> source cache hit at ...`.
- `non-nix-build/ensure_tree_sitter_nim_parser.sh` is the shared parser gate for both Unix and Windows non-Nix flows; it regenerates `libs/tree-sitter-nim/src/parser.c` only when missing or older than `grammar.js`, and now resolves CLI in this order: local `node_modules/.bin/tree-sitter`, lockfile `npm ci` (when lockfile exists), then isolated cached `tree-sitter-cli` install under `.tools/tree-sitter-cli-cache`.
- Direct probes on 2026-02-09 at `CT_REMOTE_VERSION=102d2c8` showed `DesktopClient.App-win-x64-102d2c8.tar.gz` exists (HTTP 200) but `win-arm64`, `win-aarch64`, and `win-arm64ec` variants return HTTP 404, so Windows non-x64 ct-remote bootstrap cannot be pinned yet.
- uv GitHub release assets for current pins (for example `0.9.28`) are published under `releases/download/<version>/...` (no `v` prefix); using `v<version>` for bootstrap download/checksum URLs returns 404.
- `.github/workflows/codetracer.yml` includes a focused `windows-named-pipe-tests` job on `windows-latest` that runs `cargo test --bin simple-tui windows_named_pipe -- --nocapture` in `src/tui`, providing CI coverage for Windows named-pipe DAP transport tests without invoking full workspace builds.
- Windows DIY bootstrap now supports `CT_REMOTE_WINDOWS_SOURCE_MODE` (`auto|local|download`) with `CT_REMOTE_WINDOWS_SOURCE_REPO` override and arch-aware default `CT_REMOTE_WINDOWS_SOURCE_RID` (`win-x64` on x64, `win-arm64` on arm64); in `auto`, x64 still falls back to pinned download when local source is unavailable, while arm64 remains local-source-only.
- `non-nix-build/windows/env.sh` now matches bootstrap/docs defaults for `CT_REMOTE_WINDOWS_SOURCE_RID`: if unset it resolves from host architecture (`win-x64` on x64, `win-arm64` on arm64), while explicit overrides are preserved.
- `../codetracer-ci/.github/workflows/publish-desktop-client.yml` currently comments out `win-arm64` as "not supported yet"; local source publish should therefore treat `win-arm64` as environment-dependent and use `CT_REMOTE_WINDOWS_SOURCE_RID=win-x64` override when required.
- `Invoke-WebRequest` can return checksum sidecars as `byte[]` when servers label them `binary/octet-stream` (for example, Rustup `rustup-init.exe.sha256` on Windows arm64); normalize download content to text before passing it to SHA parsing helpers.
- `windows-bootstrap-smoke` now includes deterministic arm64 routing probes that force `WINDOWS_DIY_ARCH_OVERRIDE=arm64` and trim `PATH` to avoid heavy installs, then assert Nim/Cap'n Proto/ct-remote `auto` mode follows source/local routing without x64 prebuilt/download fallback messages.
- `non-nix-build/windows/bootstrap-windows-diy.ps1` local ct-remote mode now prefers `../codetracer-ci/non-nix-build/windows/publish-desktop-client.ps1` when available (or `CT_REMOTE_WINDOWS_PUBLISH_SCRIPT` override), so local-source publish can run with codetracer-ci's repo-local dotnet bootstrap instead of requiring host-global `dotnet` on PATH.
- 2026-02-09 end-state verification on this Windows arm64 host: full default `pwsh -File non-nix-build/windows/bootstrap-windows-diy.ps1` (no skip flags), `pwsh -File non-nix-build/windows/validate-toolchain-versions.ps1`, `cargo build/test/clippy` in `src/db-backend`, and `cargo test --bin simple-tui windows_named_pipe -- --nocapture` in `src/tui` all pass.
- Windows DIY bootstrap now defaults Tup to pinned official prebuilt ZIP (`TUP_WINDOWS_SOURCE_MODE=prebuilt` with `TUP_PREBUILT_URL=https://gittup.org/tup/win32/tup-latest.zip` and pinned `TUP_PREBUILT_SHA256`), while source mode (`TUP_WINDOWS_SOURCE_MODE=source`) remains available with deterministic source cache metadata under `.tools/windows-diy/tup/cache/source/<cache-key>/`.
- Tup Windows source bootstrap now uses a codetracer-owned generated script path when `TUP_WINDOWS_SOURCE_BUILD_COMMAND` stays at its pinned default: `Ensure-TupFromSource` emits `codetracer-bootstrap-windows.sh` in the Tup source checkout, compiles Lua+Tup with MinGW (including `src/compat/win32` and `src/tup/server/windepfile.c`), and by default treats the manually built `build/tup.exe` as the final bootstrap artifact without running self-host `tup init/upd` (opt-in debug gate: `TUP_WINDOWS_SELF_HOST_UPDATE=1|true|yes|on`).
- 2026-02-09 Step-25 Tup probe (`.tmp/windows-diy-step25`, source mode, skip non-Tup steps) passes end-to-end with installed-binary validation after bundling `tup-dllinject.dll` alongside `tup.exe` in the selected install directory; `tup.exe --version` now succeeds directly from `tup.install.relative-path`.
- 2026-02-09: `Ensure-TupMsys2BuildPrereqs` must keep native command stdout off the function pipeline (now via `Out-Host`) so callers receive a pure hashtable; otherwise `Ensure-TupFromSource` can fail with `The property 'bashExe' cannot be found on this object`.
- 2026-02-09: `non-nix-build/windows/toolchain-versions.env` is sourced directly from Bash (`env.sh`), so multi-token values must be quoted (notably `TUP_SOURCE_BUILD_COMMAND` and `TUP_MSYS2_PACKAGES`) to prevent accidental command execution during `source`.
- `src/Tuprules.tup` should avoid shell-specific inline env assignment for Cargo on Windows; use `cargo build --target-dir ...` instead of `CARGO_TARGET_DIR=... cargo ...`, and use `nim` rather than hardcoded `nim1` for cross-platform Nim invocation.
- 2026-02-10 (Step 33): `non-nix-build/windows/export-msvc-env.ps1` must prepend MSVC tool include/lib paths (`VC/Tools/MSVC/<ver>/include` and `lib/<arch>`) to `INCLUDE`/`LIB`/`LIBPATH`; `vcvarsall` output on this arm64 host can otherwise omit them, causing `msvcrt.lib` and standard-header lookup failures in Tup-driven Rust/Nim builds.
- 2026-02-10 (Step 33): `src/config.nims` now forces `switch(\"cc\", \"vcc\")` on Windows so Tup-driven Nim C builds no longer depend on daemon shell env for compiler selection (`gcc.exe` was previously selected/missing).
- 2026-02-10 (Step 34): `src/common/paths.nim` must not import `std/posix` on Windows C builds; use `USERNAME` env fallback for username there to avoid generated C including `pwd.h` (missing on MSVC toolchains).
- 2026-02-10: Tup executable outputs now use a shared `EXE_SUFFIX` derived from `@(TUP_PLATFORM)` and Nim/Cargo cache exclusions must be declared in Tup `extra outputs` form (`| ^regex`), using cross-platform separator-safe regexes like `([A-Za-z]:)?[/\\]tmp[/\\]...` so `tup upd build-debug/bin/tester.exe` does not fail on undeclared `C:/tmp/ct-nim-cache/...` writes.
- 2026-02-10: On Windows, `stylus.cmd <input> -o <output>` can pass compilation but still fail Tup output tracking (`Expected to write to file ... but didn't`); using `stylus.cmd -p <input> > %o` in Tup rules makes the declared `%o` write explicit and reliable.
- 2026-02-10: In Windows DIY env, `CAPNP_DIR` can point at an install root where executables live in `CAPNP_DIR/bin`; PATH must include `CAPNP_DIR/bin` (not only `CAPNP_DIR`) so Rust build scripts that invoke `capnp` succeed under Tup/Cargo.
- 2026-02-09: `non-nix-build/ensure_tree_sitter_nim_parser.sh` now derives `ROOT_DIR` from its own location when unset, so `set -u` shells can source `non-nix-build/windows/env.sh` without `ROOT_DIR` unbound failures while preserving caller-provided `ROOT_DIR`.
- `src/db-backend` no longer depends on `expanduser`; `io-transport` now uses `shellexpand` for `~` path expansion in `src/db-backend/src/trace_processor.rs`, which removes the Windows arm64 `pwd::Passwd` transitive compile failure.
- 2026-02-09 (Windows arm64): `src/db-backend/src/core.rs` and `src/db-backend/src/rr_dispatcher.rs` now cfg-gate Unix socket transport (`UnixStream`) and return explicit runtime errors on non-Unix if rr/core socket paths are requested, so Windows builds no longer fail on `std::os::unix` imports.
- 2026-02-09 (Windows arm64): `src/db-backend/src/dap_server.rs` disconnect handling must not call `process::exit(0)` immediately after queueing the response, because that can terminate before the sending thread flushes stdio framing. The server now waits for sending-thread confirmation that the `disconnect` response was written, then terminates the main loop cleanly; with `CAPNP_DIR=.tools/windows-diy/capnp/1.3.0/cache/source/274ee662fc8ba6332580d44c2adae6dc4b36b783c761d1e4fe43c389f50597b7/install` and PATH including `$CAPNP_DIR/bin`, `cargo test`, `cargo build`, and `cargo clippy` pass in `src/db-backend`.
- 2026-02-09: `../codetracer-ci/global.json` pins SDK `9.0.0` with `rollForward=latestFeature`; on Windows arm64, exact `9.0.0` SDK download is unavailable, so repo-local bootstrap should fall back to channel `9.0` latest feature-band SDK (validated with `9.0.310`) to satisfy ct-remote/DesktopClient source bootstrap prerequisites.
- 2026-02-10 (Windows Tup + Nim 2.2.6): Nim source bootstrap no longer includes `db_sqlite` in the bundled stdlib/impure paths; `src/common/trace_index.nim` now uses version-gated imports (`../db_connector/db_sqlite` on Nim >= 2, `impure/db_sqlite` otherwise) and the Nim 2 connector sources are vendored under `src/db_connector/`.
- 2026-02-10 (Windows Tup + Nim 2.2.6 frontend): Nim now rejects several implicit JS interop conversions in frontend code; common fixes are (1) avoid capturing locals inside `nimcall` event handlers (derive target elements from `event.currentTarget` instead), (2) cast enum bitflags explicitly when assigning `int` fields in macro-generated nodes (for example `menuOs: ord(menuOsEnum)`), and (3) use `jsre.contains(...)` instead of `.test(...)`.
- 2026-02-10 (Windows Tup full graph): for `!codetracer` C builds, per-target Nim caches (`--nimcache:/tmp/ct-nim-cache/%B_codetracer_binary`) avoid cross-target cache races, and Tup must ignore both Nim cache paths and Nim-generated `*_linkerArgs.txt` response files (`NIM_SIDE_OUTPUTS_IGNORE`) to prevent undeclared-output failures.
- 2026-02-10 (Windows ct launcher): `src/ct/launch/backends.nim` and `src/ct/launch/cleanup.nim` must `cfg`-gate POSIX signal handling (`posix`, `posix_utils`, `onSignal`, `kill`) on non-Windows, otherwise MinGW Nim C builds fail on missing `kill`/signal APIs.
- 2026-02-10 (ct-remote arm64 downloads): URL probes against `https://downloads.codetracer.com/DesktopClient.App` for revision `102d2c8` still return HTTP 404 for `win-arm64`, `win-aarch64`, and `win-arm64ec` while `win-x64` is HTTP 200; keep arm64 bootstrap on local-source mode until an official arm64 artifact and SHA are published.
- 2026-02-10: `just build-once` should create `src/public/dist` (not repo-root `public/dist`) and use `mkdir -p` so fresh Windows checkouts do not emit/fail on missing parent directory before Tup/Webpack runs.
- 2026-02-10: Tup Rust rules should avoid inline Cargo `--config target.*.linker=\"rust-lld\"` quoting on Windows; shell quoting differences can break parsing. Keep linker selection in Cargo config/env and invoke `cargo build` without those inline `--config` fragments.
- 2026-02-10: Windows non-Nix now has a PowerShell-native env bootstrap script at `non-nix-build/windows/env.ps1`; use dot-sourcing (`. .\non-nix-build\windows\env.ps1`) so variables persist in-session, mirroring `env.sh` behavior for PowerShell users.
- 2026-02-11: `ct.exe` on Windows requires `ct_paths.json`; non-Nix Windows env scripts now run `non-nix-build/windows/setup-codetracer-runtime-env.{sh,ps1}` to create that file when missing and to export `NIX_CODETRACER_EXE_DIR`/`LINKS_PATH_DIR`/`CODETRACER_REPO_ROOT_PATH` plus a default `CODETRACER_E2E_CT_PATH`.
- 2026-02-11: Windows non-Nix env now pins `.NET` via `DOTNET_SDK_VERSION` in `non-nix-build/windows/toolchain-versions.env`; `env.ps1` and `env.sh` export `DOTNET_ROOT`, prepend it to PATH, and fail fast if that SDK version is not installed.
- 2026-02-11: Even when Nim source mode is active, `ct.exe` on Windows can require OpenSSL 1.1 DLLs (`libcrypto-1_1-x64.dll`/`libssl-1_1-x64.dll`) shipped in Nim prebuilt `bin`; keep `$WINDOWS_DIY_INSTALL_ROOT/nim/<ver>/prebuilt/nim-<ver>/bin` on PATH before running UI tests.
- 2026-02-11: In Git Bash launched from PowerShell, Tup may be unavailable as bare `tup` even when the executable is on PATH as `tup.exe`; `just` bash recipes should invoke `${TUP:-tup}` and Windows env setup should export `TUP` to the full `tup.exe` path for deterministic resolution.
- 2026-02-11: Windows non-Nix devenv now emits Bash shims under `$WINDOWS_DIY_INSTALL_ROOT/shims` for key `.exe` tools (`tup`, `dotnet`, `node`, `npm`, `npx`, `uv`, `capnp`, `capnpc-c++`, `nargo`, `nim`, `ct-remote`, `cargo`, `rustc`, `rustup`) and prepends that directory to PATH so Bash can invoke tools by extensionless names consistently.
- 2026-02-11: On Windows, `just` inline bash recipes can fail before execution with `/bin/bash: C:...Temp...just-...: No such file or directory`; moving recipe bodies to `scripts/*.sh` and calling them via `bash scripts/<name>.sh` avoids temp-script path translation issues.
- 2026-02-11: `non-nix-build/windows/env.ps1` now honors `WINDOWS_DIY_ENSURE_DOTNET=0` (matching `env.sh`) so PATH/shim setup can proceed on hosts without the pinned SDK, and it exports `WINDOWS_DIY_SHIMS_DIR` while re-prepending that directory after runtime-env setup to keep shims visible at the front of PATH.
- 2026-02-11: `non-nix-build/windows/env.ps1` .NET validation now supports feature-band roll-forward by default (`WINDOWS_DIY_DOTNET_ROLL_FORWARD_FEATURE=1`): if exact pinned `DOTNET_SDK_VERSION` is missing, it selects the highest installed SDK with the same major.minor (e.g., `9.0.311` for pinned `9.0.310`) and stores it in `DOTNET_SDK_VERSION_EFFECTIVE`.
- 2026-02-11: `non-nix-build/windows/env.ps1` now prefers Git Bash by default (`WINDOWS_DIY_PREFER_GIT_BASH=1`) by prepending detected `Git\bin`/`Git\usr\bin` to PATH; `Get-Command bash` should resolve to Git Bash, and `WINDOWS_DIY_GIT_BASH_BIN` reports the selected directory.
- 2026-02-11: On Windows, Tup command failures like `'stylus' is not recognized` can come from a stale Tup server started with an older PATH; after sourcing env scripts, restart Tup-related processes before rebuilding. `env.ps1` also now sets PowerShell aliases (`tup`, `node`, `npm`, `npx`, etc.) to `.exe` paths so extensionless Bash shims on PATH do not get opened as text files in PowerShell.
- 2026-02-11: Web UI tests in non-Nix Windows rely on additional runtime assets under `src/build-debug` beyond binaries: `ct host` serves static files from `src/build-debug/public` and `ct record` expects `src/build-debug/config/default_config.yaml`; `setup-codetracer-runtime-env.{ps1,sh}` should ensure both `public` and `config` are linked/copied from `src/`.
- 2026-02-11: `src/frontend/index.html` can request `frontend/styles/default_dark_theme.css` in web/server mode; if only `default_dark_theme_extension.css` is generated, add a build artifact alias/copy so the unsuffixed path resolves.
- 2026-02-11: `ct-rr-support` now compiles on Windows in `../codetracer-rr-backend` via Windows stubs (compile-only mode), but runtime replay/record integration remains unsupported on Windows because RR is Linux-only; `ct record test-programs/noir_space_ship` can still fail when it requires a functional `ct-rr-support` runtime backend.
- 2026-02-11: On this Windows non-Nix setup, Noir recording currently hangs in `nargo trace` (often with git dependency cache lock behavior), so `ct record test-programs/noir_space_ship` can leave `trace-*` folders with only `symbols.json`.
- 2026-02-12: `ct host` treats its final trace argument as either a numeric trace id or an already indexed/imported trace path; passing an arbitrary fixture folder (for example `src/tui/trace`) can fail with `trace not found: maybe you should import it first`. `ui-tests/Infrastructure/CtHostLauncher.cs` now translates `.../trace-<id>` paths to `<id>` before launching `ct host`.
- 2026-02-11: Installing `Microsoft.WinDbg` alone may expose TTD binaries under `C:\Program Files\WindowsApps\...` with ACL restrictions for direct execution; installing `Microsoft.TimeTravelDebugging` provides a usable `ttd.exe` alias in `%LOCALAPPDATA%\Microsoft\WindowsApps`, and non-Nix Windows env scripts now auto-detect/export it as `WINDOWS_DIY_TTD_EXE` plus a bash shim.
- 2026-02-11: `%LOCALAPPDATA%\Microsoft\WindowsApps\ttd.exe` and `WinDbgX.exe` are App execution aliases (stubs) that do not carry reliable file version metadata; use `Get-AppxPackage` (`Microsoft.TimeTravelDebugging` / `Microsoft.WinDbg`) for deterministic version checks and `InstallLocation`-based paths (for example `TTDReplay.dll`).
- 2026-02-11: Tracepoint grammar includes `callExpression`, and `src/db-backend/src/tracepoint_interpreter/compiler.rs` now compiles call expressions for TTD tracepoint evaluation.
- 2026-02-12: For machine-facing TTD APIs on Windows, `dbgeng.dll` from the WinDbg AppX install path may fail direct `LoadLibrary` with `Access is denied`; `C:\Windows\System32\dbgeng.dll` is loadable and supports `DebugCreate`/`DebugConnectWide`. Also, current `cdb` rejects `dx -j` for `@$...TTD...` expressions, so command-log parsing remains text-first unless debugger version changes.
